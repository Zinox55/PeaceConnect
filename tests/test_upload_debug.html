<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Upload Debug</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 20px; border: 2px solid #ddd; border-radius: 8px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        button { padding: 10px 20px; margin: 10px 5px 0 0; cursor: pointer; }
        input[type="file"] { margin: 10px 0; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }
        h2 { margin-top: 0; }
    </style>
</head>
<body>
    <h1>üîç Test Upload Debug - PeaceConnect</h1>

    <div class="section">
        <h2>√âtape 1: S√©lectionner une image</h2>
        <input type="file" id="imageFile" accept="image/*">
        <div id="preview"></div>
    </div>

    <div class="section">
        <h2>√âtape 2: Upload vers serveur</h2>
        <button onclick="testUpload()">üì§ Tester Upload</button>
        <div id="uploadResult"></div>
    </div>

    <div class="section">
        <h2>√âtape 3: Cr√©er produit avec image</h2>
        <input type="text" id="nomProduit" placeholder="Nom du produit" style="padding: 8px; width: 300px;">
        <input type="number" id="prixProduit" placeholder="Prix" style="padding: 8px; width: 100px;">
        <input type="number" id="stockProduit" placeholder="Stock" style="padding: 8px; width: 100px;">
        <button onclick="testCreateProduit()">‚ûï Cr√©er Produit</button>
        <div id="createResult"></div>
    </div>

    <div class="section">
        <h2>üìä Console de logs</h2>
        <div id="console" style="background: #000; color: #0f0; padding: 15px; border-radius: 4px; min-height: 200px; font-family: monospace; font-size: 12px;"></div>
    </div>

    <script>
        const UPLOAD_URL = 'controller/UploadController.php';
        const PRODUIT_URL = 'controller/ProduitController.php';
        let uploadedFilename = '';

        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#f00' : type === 'success' ? '#0f0' : '#fff';
            console.innerHTML += `<div style="color: ${color}">[${time}] ${message}</div>`;
            console.scrollTop = console.scrollHeight;
        }

        // Aper√ßu de l'image
        document.getElementById('imageFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                log(`üìÅ Fichier s√©lectionn√©: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`, 'info');
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('preview').innerHTML = 
                        `<img src="${e.target.result}" style="max-width: 200px; margin-top: 10px; border: 2px solid #ddd; border-radius: 4px;">`;
                };
                reader.readAsDataURL(file);
            }
        });

        async function testUpload() {
            const fileInput = document.getElementById('imageFile');
            const resultDiv = document.getElementById('uploadResult');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                log('‚ùå Aucun fichier s√©lectionn√©', 'error');
                resultDiv.innerHTML = '<div class="error">‚ùå Veuillez s√©lectionner une image</div>';
                return;
            }

            const file = fileInput.files[0];
            log(`üì§ Upload en cours: ${file.name}`, 'info');
            
            const formData = new FormData();
            formData.append('image', file);
            
            try {
                const response = await fetch(UPLOAD_URL, {
                    method: 'POST',
                    body: formData
                });
                
                log(`üì° R√©ponse re√ßue (status: ${response.status})`, 'info');
                
                const data = await response.json();
                log(`üì¶ Donn√©es: ${JSON.stringify(data, null, 2)}`, 'info');
                
                if (data.success) {
                    uploadedFilename = data.filename;
                    log(`‚úÖ Upload r√©ussi! Nom: ${uploadedFilename}`, 'success');
                    resultDiv.innerHTML = `
                        <div class="success">
                            <strong>‚úÖ Upload r√©ussi!</strong><br>
                            Nom du fichier: <code>${data.filename}</code><br>
                            Chemin: <code>${data.path}</code>
                        </div>
                    `;
                } else {
                    log(`‚ùå Erreur serveur: ${data.message}`, 'error');
                    resultDiv.innerHTML = `<div class="error">‚ùå ${data.message}</div>`;
                }
            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error');
                resultDiv.innerHTML = `<div class="error">‚ùå Erreur: ${error.message}</div>`;
            }
        }

        async function testCreateProduit() {
            const resultDiv = document.getElementById('createResult');
            const nom = document.getElementById('nomProduit').value;
            const prix = document.getElementById('prixProduit').value;
            const stock = document.getElementById('stockProduit').value;

            if (!nom || !prix || !stock) {
                log('‚ùå Veuillez remplir tous les champs', 'error');
                resultDiv.innerHTML = '<div class="error">‚ùå Veuillez remplir tous les champs</div>';
                return;
            }

            if (!uploadedFilename) {
                log('‚ö†Ô∏è Aucune image upload√©e, le produit sera cr√©√© sans image', 'info');
            }

            const produitData = {
                nom: nom,
                description: 'Test produit',
                prix: prix,
                stock: stock,
                image: uploadedFilename
            };

            log(`üì§ Cr√©ation produit: ${JSON.stringify(produitData, null, 2)}`, 'info');

            try {
                const response = await fetch(PRODUIT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(produitData)
                });

                log(`üì° R√©ponse re√ßue (status: ${response.status})`, 'info');
                
                const data = await response.json();
                log(`üì¶ Donn√©es: ${JSON.stringify(data, null, 2)}`, 'info');

                if (data.success) {
                    log(`‚úÖ Produit cr√©√© avec ID: ${data.id}`, 'success');
                    resultDiv.innerHTML = `
                        <div class="success">
                            <strong>‚úÖ Produit cr√©√©!</strong><br>
                            ID: ${data.id}<br>
                            Nom: ${nom}<br>
                            Prix: ${prix}‚Ç¨<br>
                            Stock: ${stock}<br>
                            Image: ${uploadedFilename || 'Aucune'}
                        </div>
                    `;
                } else {
                    log(`‚ùå Erreur: ${data.message}`, 'error');
                    resultDiv.innerHTML = `<div class="error">‚ùå ${data.message}</div>`;
                }
            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error');
                resultDiv.innerHTML = `<div class="error">‚ùå Erreur: ${error.message}</div>`;
            }
        }

        log('üöÄ Page de test charg√©e', 'success');
    </script>
</body>
</html>
