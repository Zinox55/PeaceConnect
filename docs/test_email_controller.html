<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Test EmailController</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-btn { background: #5F9E7F; color: white; padding: 15px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; margin: 10px; }
        .test-btn:hover { background: #4a7d63; }
        .result { margin-top: 20px; padding: 20px; border-radius: 8px; }
        .success { background: #d4edda; color: #155724; border-left: 5px solid #28a745; }
        .error { background: #f8d7da; color: #721c24; border-left: 5px solid #dc3545; }
        .info { background: #d1ecf1; color: #0c5460; border-left: 5px solid #17a2b8; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üß™ Test EmailController</h1>
    <hr>
    
    <h2>1. R√©cup√©rer la derni√®re commande</h2>
    <button class="test-btn" onclick="getDerniereCommande()">üìã R√©cup√©rer derni√®re commande</button>
    <div id="commandeResult"></div>
    
    <hr>
    
    <h2>2. Tester l'envoi d'email de confirmation</h2>
    <p>Num√©ro de commande: <input type="text" id="numeroCommande" placeholder="CMD-XXXXXXXX" style="padding: 8px; width: 300px;"></p>
    <button class="test-btn" onclick="testEnvoiEmail()">üìß Envoyer email de confirmation</button>
    <div id="emailResult"></div>
    
    <hr>
    
    <h2>3. Test complet (commande + email)</h2>
    <button class="test-btn" onclick="testComplet()">üöÄ Test complet</button>
    <div id="completResult"></div>

    <script>
        // Fonction pour r√©cup√©rer la derni√®re commande
        async function getDerniereCommande() {
            const resultDiv = document.getElementById('commandeResult');
            resultDiv.innerHTML = '<div class="result info">‚è≥ Chargement...</div>';
            
            try {
                const response = await fetch('../../controller/CommandeController.php?action=derniere');
                const data = await response.json();
                
                if (data.success && data.commande) {
                    const commande = data.commande;
                    document.getElementById('numeroCommande').value = commande.numero_commande;
                    
                    resultDiv.innerHTML = `
                        <div class="result success">
                            <h3>‚úì Commande trouv√©e</h3>
                            <p><strong>Num√©ro:</strong> ${commande.numero_commande}</p>
                            <p><strong>Client:</strong> ${commande.nom_client}</p>
                            <p><strong>Email:</strong> ${commande.email_client}</p>
                            <p><strong>Total:</strong> ${parseFloat(commande.total).toFixed(2)} ‚Ç¨</p>
                            <p><strong>Date:</strong> ${commande.date_creation}</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="result error">‚ùå ${data.message || 'Aucune commande trouv√©e'}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">‚ùå Erreur: ${error.message}</div>`;
            }
        }
        
        // Fonction pour tester l'envoi d'email
        async function testEnvoiEmail() {
            const numeroCommande = document.getElementById('numeroCommande').value;
            const resultDiv = document.getElementById('emailResult');
            
            if (!numeroCommande) {
                resultDiv.innerHTML = '<div class="result error">‚ùå Veuillez entrer un num√©ro de commande</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="result info">üìß Envoi de l\'email en cours...</div>';
            
            try {
                const url = `../../controller/EmailController.php?action=confirmation&numero=${encodeURIComponent(numeroCommande)}`;
                console.log('URL:', url);
                
                const response = await fetch(url);
                const text = await response.text();
                console.log('Response text:', text);
                
                // Essayer de parser en JSON
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    // Si ce n'est pas du JSON, afficher le contenu brut
                    resultDiv.innerHTML = `
                        <div class="result error">
                            <h3>‚ùå R√©ponse invalide (pas du JSON)</h3>
                            <p>La r√©ponse du serveur n'est pas au format JSON. Cela peut √™tre d√ª au mode debug de PHPMailer.</p>
                            <h4>R√©ponse brute:</h4>
                            <pre>${text.substring(0, 1000)}${text.length > 1000 ? '...' : ''}</pre>
                        </div>
                    `;
                    return;
                }
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="result success">
                            <h3>‚úÖ Email envoy√© avec succ√®s !</h3>
                            <p><strong>Message:</strong> ${data.message}</p>
                            <p><strong>Envoy√© √†:</strong> ${data.sent_to || 'N/A'}</p>
                            <p>V√©rifiez la bo√Æte mail (et le dossier spam).</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="result error">
                            <h3>‚ùå Erreur d'envoi</h3>
                            <p><strong>Message:</strong> ${data.message || 'Erreur inconnue'}</p>
                            <h4>R√©ponse compl√®te:</h4>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        <h3>‚ùå Erreur de connexion</h3>
                        <p><strong>Message:</strong> ${error.message}</p>
                    </div>
                `;
            }
        }
        
        // Test complet
        async function testComplet() {
            const resultDiv = document.getElementById('completResult');
            resultDiv.innerHTML = '<div class="result info">üöÄ Test en cours...</div>';
            
            try {
                // 1. R√©cup√©rer la derni√®re commande
                resultDiv.innerHTML += '<p>1Ô∏è‚É£ R√©cup√©ration de la derni√®re commande...</p>';
                const response1 = await fetch('../../controller/CommandeController.php?action=derniere');
                const data1 = await response1.json();
                
                if (!data1.success || !data1.commande) {
                    resultDiv.innerHTML = '<div class="result error">‚ùå Aucune commande trouv√©e</div>';
                    return;
                }
                
                const commande = data1.commande;
                resultDiv.innerHTML += `<p style="color: green;">‚úì Commande trouv√©e: ${commande.numero_commande}</p>`;
                
                // 2. Envoyer l'email
                resultDiv.innerHTML += '<p>2Ô∏è‚É£ Envoi de l\'email de confirmation...</p>';
                const response2 = await fetch(`../../controller/EmailController.php?action=confirmation&numero=${commande.numero_commande}`);
                const text = await response2.text();
                
                let data2;
                try {
                    data2 = JSON.parse(text);
                } catch (e) {
                    resultDiv.innerHTML += `
                        <div class="result error">
                            <h3>‚ùå Erreur: R√©ponse invalide</h3>
                            <pre>${text.substring(0, 500)}</pre>
                        </div>
                    `;
                    return;
                }
                
                if (data2.success) {
                    resultDiv.innerHTML += `
                        <div class="result success">
                            <h3>‚úÖ TEST COMPLET R√âUSSI !</h3>
                            <p><strong>Commande:</strong> ${commande.numero_commande}</p>
                            <p><strong>Email envoy√© √†:</strong> ${data2.sent_to}</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML += `
                        <div class="result error">
                            <h3>‚ùå Erreur d'envoi</h3>
                            <p>${data2.message}</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                resultDiv.innerHTML += `<div class="result error">‚ùå Erreur: ${error.message}</div>`;
            }
        }
        
        // Charger automatiquement la derni√®re commande au chargement
        window.onload = function() {
            getDerniereCommande();
        };
    </script>
</body>
</html>
